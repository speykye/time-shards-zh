<div class="ts-root" id="ts-root">
    <div class="ts-rider-bookmark" (click)="goBack()">
        <div class="ts-bookmark-tab">
            <!-- å›¾æ ‡ï¼šè¿”å›ç®­å¤´ -->
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                stroke-linecap="round" stroke-linejoin="round">
                <path d="M19 12H5M12 19l-7-7 7-7" />
            </svg>
            <span class="ts-bookmark-text">è¿”å›</span>
        </div>
        <!-- è£…é¥°ç”¨çš„ä¸‰è§’å½¢æŠ˜è§’æ•ˆæœ -->
        <div class="ts-bookmark-fold"></div>
    </div>
    <!-- ===== Header ===== -->
    <header class="ts-header">
        <div class="ts-title-row">
            <div class="ts-title-left">
                <div class="ts-logo-pill">â±</div>
                <div>
                    <h1 class="ts-title">Time-Shards</h1>
                    <p class="ts-subtitle">å§”æ‰˜é¡¹ç›®é‡Œç¨‹ç¢‘ä¸ä¿®è®¢çš„æ¸©é¦¨è®°å½•æœ¬ Â· æœ¬åœ°ä¼˜å…ˆ Â· éšç§å®‰å…¨</p>
                </div>
            </div>

            <div class="ts-toolbar">
                <button type="button" class="ts-btn ghost" (click)="exportJson()" [disabled]="!hasProjects()">
                    <span>ğŸ“¥</span> å¯¼å‡ºå¤‡ä»½
                </button>

                <label class="ts-btn ghost file-label">
                    <span>ğŸ“‚</span> å¯¼å…¥æ•°æ®
                    <input type="file" accept="application/json" (change)="onImportFileSelected($event)" />
                </label>
            </div>
        </div>
    </header>

    <main class="ts-main">
        <!-- ===== Sidebar: Projects ===== -->
        <section class="ts-sidebar">
            <div class="ts-card">
                <div class="ts-section-title">å·¥å…·ç®±</div>

                <!-- å¯¼èˆªæŒ‰é’®ç»„ -->
                <div class="ts-nav-list">
                    <button class="ts-nav-item" [class.active]="currentView() === 'timeline'"
                        (click)="switchView('timeline')">
                        <span>ğŸ“œ</span> é¡¹ç›®æ—¶é—´è½´
                    </button>

                    <button class="ts-nav-item" [class.active]="currentView() === 'calculator'"
                        (click)="switchView('calculator')">
                        <span>ğŸ§®</span> è´¹ç‡è®¡ç®—å™¨
                    </button>
                </div>
            </div>
            @if(currentView() === 'timeline') {
            <h2 class="ts-section-title">æˆ‘çš„é¡¹ç›®</h2>

            @if (projects().length) {
            <div class="ts-project-list">
                @for (p of projects(); track p.id; let i = $index) {
                <button class="ts-project-item" [ngClass]="{ active: i === currentProjectIndex() }" type="button"
                    (click)="selectProject(i)">
                    <div class="ts-project-name">{{ p.name }}</div>
                    <div class="ts-project-meta">
                        {{ p.shards.length }} æ¡è®°å½•
                    </div>
                </button>
                }
            </div>
            } @else {
            <div class="ts-empty-text">
                <p>ğŸƒ æš‚æ— é¡¹ç›®</p>
                <p style="font-size: 0.8rem; margin-top: 0.5rem;">åœ¨ä¸‹æ–¹åˆ›å»ºæ‚¨çš„ç¬¬ä¸€ä¸ªå§”æ‰˜é¡¹ç›®å§</p>
            </div>
            }
            <div class="ts-new-project">
                <label class="ts-input-label">æ–°å»ºé¡¹ç›®</label>
                <div class="ts-new-project-row">
                    <input #projectName class="ts-input" type="text" placeholder="ä¾‹å¦‚ï¼šç‹¼äººè®¾å®šå›¾ã€Vtuber æ¨¡å‹..."
                        (keyup.enter)="addProject(projectName)" />
                    <button class="ts-btn primary" type="button" (click)="addProject(projectName)">åˆ›å»º</button>
                </div>

                @if (currentProject()) {
                <button type="button" class="ts-btn subtle ts-delete-project" (click)="deleteCurrentProject()">
                    åˆ é™¤å½“å‰é¡¹ç›®
                </button>
                }
            </div>
            }
        </section>
        <!-- ===== Right panel ===== -->
        @if (currentView() === 'timeline') {
        @if (currentProject(); as cp) {
        <section class="ts-panel">
            <!-- ===== Form Card ===== -->
            <div class="ts-card ts-form-card">
                <div class="ts-form-header" style="margin-bottom: 1rem;">
                    <h2 class="ts-section-title" style="font-size: 1rem; color: var(--sd-text-strong);">
                        {{ isEditing() ? 'âœï¸ ç¼–è¾‘è®°å½•' : 'â• æ–°å¢è®°å½•' }}
                        <span style="font-weight: 400; color: var(--sd-muted); font-size: 0.9em;">Â· {{ cp.name }}</span>
                    </h2>
                </div>

                <!-- project summary -->
                <div class="ts-form-field ts-form-field--full ts-summary-field">
                    <label class="ts-input-label">é¡¹ç›®ç®€ä»‹</label>
                    <input class="ts-input" type="text" placeholder="ä¸€å¥è¯æè¿°é¡¹ç›®ï¼Œå¦‚ï¼šNSFW ç‹¼äººè®¾å®šå›¾ï¼Œ3 ä¸ªå§¿åŠ¿ï¼ŒåŠ æ€¥"
                        [ngModel]="cp.summary || ''" (ngModelChange)="onSummaryChange($event)" />
                </div>

                <div class="ts-form-grid">
                    <div class="ts-form-field">
                        <label class="ts-input-label">ç±»å‹</label>
                        <select class="ts-select" [ngModel]="shardKind()" (ngModelChange)="shardKind.set($event)">
                            <option value="Note">ğŸ“ å¤‡æ³¨</option>
                            <option value="Milestone">ğŸš© é‡Œç¨‹ç¢‘</option>
                            <option value="Letter">ğŸ“¨ ä¿¡å‡½/åè®®</option>
                        </select>
                    </div>

                    <div class="ts-form-field">
                        <label class="ts-input-label">å½’å±æ–¹</label>
                        <select class="ts-select" [ngModel]="shardSide()" (ngModelChange)="shardSide.set($event)">
                            <option value="Artist">ğŸ¨ ç”»å¸ˆ</option>
                            <option value="Client">ğŸ’° é‡‘ä¸»</option>
                            <option value="Both">ğŸ¤ åŒæ–¹</option>
                        </select>
                    </div>
                </div>

                <!-- Milestone extra -->
                @if (shardKind() === 'Milestone') {
                <div class="ts-form-grid">
                    <div class="ts-form-field">
                        <label class="ts-input-label">æˆªæ­¢æ—¥æœŸ</label>
                        <input class="ts-input" type="date" [ngModel]="milestoneDueAt()"
                            (ngModelChange)="milestoneDueAt.set($event)" />
                    </div>
                    <div class="ts-form-field">
                        <label class="ts-input-label">çŠ¶æ€</label>
                        <select class="ts-select" [ngModel]="milestoneStatus()"
                            (ngModelChange)="milestoneStatus.set($event)">
                            <option value="planned">ğŸ“… è®¡åˆ’ä¸­</option>
                            <option value="in_progress">ğŸ”¨ è¿›è¡Œä¸­</option>
                            <option value="done">âœ… å·²å®Œæˆ</option>
                        </select>
                    </div>
                </div>
                }

                <!-- Note extra -->
                @if (shardKind() === 'Note') {
                <div class="ts-form-grid">
                    <div class="ts-form-field">
                        <label class="ts-input-label">å…³è”é‡Œç¨‹ç¢‘</label>
                        <select class="ts-select" [ngModel]="noteMilestoneId()"
                            (ngModelChange)="noteMilestoneId.set($event)">
                            <option value="">(æ— å…³è”)</option>
                            @for (m of milestonesForCurrentProject(); track m.id) {
                            <option [value]="m.id">{{ m.label }}</option>
                            }
                        </select>
                    </div>
                </div>
                }

                <!-- Letter extra -->
                @if (shardKind() === 'Letter') {
                <div class="ts-form-grid">
                    <div class="ts-form-field">
                        <label class="ts-input-label">ä¿¡å‡½ç±»å‹</label>
                        <select class="ts-select" [ngModel]="letterType()" (ngModelChange)="letterType.set($event)">
                            <option value="Proposal">ğŸ“„ ææ¡ˆ</option>
                            <option value="Change">âš ï¸ å˜æ›´è¯·æ±‚</option>
                            <option value="Acceptance">ğŸ‰ éªŒæ”¶ç¡®è®¤</option>
                        </select>
                    </div>

                    <div class="ts-form-field">
                        <label class="ts-input-label">å…³è”é‡Œç¨‹ç¢‘</label>
                        <select class="ts-select" [ngModel]="letterMilestoneId()"
                            (ngModelChange)="letterMilestoneId.set($event)">
                            <option value="">(æ— å…³è”)</option>
                            @for (m of milestonesForCurrentProject(); track m.id) {
                            <option [value]="m.id">{{ m.label }}</option>
                            }
                        </select>
                    </div>
                </div>

                <div class="ts-form-field ts-form-field--full" style="margin-top: 0.5rem;">
                    <label class="ts-input-label">ç»“æ„åŒ–æ¡æ¬¾ (é˜²æ‰¯çš®ä¸“ç”¨)</label>
                    <div class="ts-letter-fields"
                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem;">
                        <div class="ts-form-field">
                            <label class="ts-input-label">äº¤ä»˜å†…å®¹</label>
                            <input class="ts-input" type="text" [ngModel]="lfDeliverables()"
                                (ngModelChange)="lfDeliverables.set($event)" />
                        </div>
                        <div class="ts-form-field">
                            <label class="ts-input-label">ç”¨é€”æˆæƒ</label>
                            <input class="ts-input" type="text" placeholder="ä¸ªäºº / å•†ä¸š" [ngModel]="lfUsage()"
                                (ngModelChange)="lfUsage.set($event)" />
                        </div>
                        <div class="ts-form-field">
                            <label class="ts-input-label">æˆªæ­¢æœŸé™</label>
                            <input class="ts-input" type="date" [ngModel]="lfDeadline()"
                                (ngModelChange)="lfDeadline.set($event)" />
                        </div>
                        <div class="ts-form-field">
                            <label class="ts-input-label">ä¿®æ”¹æ¬¡æ•°</label>
                            <input class="ts-input" type="text" placeholder="ä¾‹ï¼š2 è½®å¤§æ”¹" [ngModel]="lfRevisions()"
                                (ngModelChange)="lfRevisions.set($event)" />
                        </div>
                        <div class="ts-form-field" style="grid-column: span 2;">
                            <label class="ts-input-label">éªŒæ”¶æ ‡å‡† & èŒƒå›´è¾¹ç•Œ</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input class="ts-input" type="text" placeholder="éªŒæ”¶æ ‡å‡†" [ngModel]="lfAcceptance()"
                                    (ngModelChange)="lfAcceptance.set($event)" style="flex:1" />
                                <input class="ts-input" type="text" placeholder="ä¸åŒ…å«çš„å†…å®¹" [ngModel]="lfScope()"
                                    (ngModelChange)="lfScope.set($event)" style="flex:1" />
                            </div>
                        </div>
                        <div class="ts-form-field" style="grid-column: span 2;">
                            <label class="ts-input-label">å‚è€ƒé“¾æ¥</label>
                            <textarea class="ts-textarea" style="min-height: 60px;" [ngModel]="lfRefs()"
                                (ngModelChange)="lfRefs.set($event)"></textarea>
                        </div>
                    </div>
                </div>

                <div class="ts-form-actions ts-form-actions--left"
                    style="justify-content: flex-start; border:none; padding:0;">
                    <button type="button" class="ts-btn ghost" (click)="copyLetterTextFromForm()">ğŸ“‹ å¤åˆ¶ä¿¡å‡½æ–‡æœ¬</button>
                </div>

                @if (letterPreviewText()) {
                <div class="ts-letter-preview" style="margin-top: 0.5rem;">
                    <label class="ts-input-label">é¢„è§ˆ</label>
                    <pre class="ts-letter-preview-box"
                        style="background:#f5f7fa; padding:0.75rem; border-radius:6px; font-size:0.85rem; white-space:pre-wrap; border:1px solid #ebeef5;">{{ letterPreviewText() }}</pre>
                </div>
                }
                }

                <!-- Common label/details -->
                <div class="ts-form-grid" style="margin-top: 0.5rem;">
                    <div class="ts-form-field" style="grid-column: span 2;">
                        <label class="ts-input-label">
                            @if (shardKind() === 'Milestone') { é‡Œç¨‹ç¢‘æ ‡é¢˜ } @else { ç®€çŸ­ä¸»é¢˜ }
                        </label>
                        <input class="ts-input" type="text" placeholder="ä¾‹ï¼šè‰å›¾ç¡®è®¤ / å˜æ›´è¯·æ±‚ / å°¾æ¬¾æ”¯ä»˜" [ngModel]="shardLabel()"
                            (ngModelChange)="shardLabel.set($event)" />
                    </div>
                </div>

                <div class="ts-form-field ts-form-field--full">
                    <label class="ts-input-label">è¯¦ç»†å†…å®¹</label>
                    <textarea class="ts-textarea" placeholder="è®°å½•å…·ä½“çš„æ²Ÿé€šç»†èŠ‚ã€æ–‡ä»¶å¾€æ¥ã€ç‰¹æ®Šçº¦å®šç­‰..." [ngModel]="shardDetails()"
                        (ngModelChange)="shardDetails.set($event)"></textarea>
                </div>

                <div class="ts-form-actions">
                    @if (!isEditing()) {
                    <button type="button" class="ts-btn ghost" (click)="clearShardForm()">é‡ç½®</button>
                    } @else {
                    <button type="button" class="ts-btn ghost" (click)="cancelEditShard()">å–æ¶ˆ</button>
                    }

                    <button type="button" class="ts-btn primary" (click)="saveShard()">
                        {{ isEditing() ? 'ğŸ’¾ ä¿å­˜ä¿®æ”¹' : 'âœ¨ ä¿å­˜è®°å½•' }}
                    </button>
                </div>

                <div style="text-align: center; font-size: 0.75rem; color: var(--sd-muted); margin-top: 0.5rem;">
                    ğŸ’¡ æç¤ºï¼šå…ˆåˆ›å»ºè®°å½•ï¼Œå†åœ¨è¯¥è®°å½•ä¸‹ä¸Šä¼ æ–‡ä»¶å“ˆå¸Œä½œä¸ºè¯æ®ã€‚
                </div>
            </div>

            <!-- ===== Log Card ===== -->
            <div class="ts-card ts-log-card">
                <div class="ts-log-header">
                    <div class="ts-log-header-main">
                        <h2 class="ts-section-title" style="font-size: 1rem; color: var(--sd-text-strong);">
                            ğŸ“œ æ—¶é—´çº¿
                            <span style="font-weight: 400; font-size: 0.85em; color: var(--sd-muted);">
                                (æ˜¾ç¤º {{ visibleShards().length }} / {{ shardsForCurrentProject().length }})
                            </span>
                        </h2>
                        @if (cp.summary) {
                        <p class="ts-project-summary"
                            style="font-size: 0.8rem; color: var(--sd-muted); margin: 0.25rem 0 0;">
                            {{ cp.summary }}
                        </p>
                        }
                    </div>

                    <div class="ts-log-controls">
                        <div class="ts-log-search">
                            <input class="ts-input ts-input--compact" type="text" placeholder="ğŸ” æœç´¢å…³é”®è¯..."
                                [ngModel]="searchTerm()" (ngModelChange)="searchTerm.set($event)" />
                        </div>

                        <div class="ts-log-ms-filter" style="flex: 0 0 auto;">
                            <select class="ts-select ts-select--compact" [ngModel]="filterMilestone()"
                                (ngModelChange)="filterMilestone.set($event)">
                                <option value="all">æ‰€æœ‰é‡Œç¨‹ç¢‘</option>
                                <option value="unbound">æœªå…³è”äº‹é¡¹</option>
                                @for (m of milestoneSpine(); track m.id) {
                                <option [value]="m.id">{{ m.label || '(æœªå‘½å)' }}</option>
                                }
                            </select>
                        </div>

                        @if (filterMilestone() !== 'all') {
                        <button type="button" class="ts-filter-chip active" (click)="clearMilestoneFilter()"
                            style="padding: 0.2rem 0.5rem;">
                            âœ•
                        </button>
                        }

                        <div class="ts-filter-chips">
                            <button type="button" class="ts-filter-chip" [ngClass]="{ active: filterSide() === 'All' }"
                                (click)="filterSide.set('All')">å…¨éƒ¨</button>
                            <button type="button" class="ts-filter-chip"
                                [ngClass]="{ active: filterSide() === 'Artist' }"
                                (click)="filterSide.set('Artist')">ç”»å¸ˆ</button>
                            <button type="button" class="ts-filter-chip"
                                [ngClass]="{ active: filterSide() === 'Client' }"
                                (click)="filterSide.set('Client')">é‡‘ä¸»</button>
                            <button type="button" class="ts-filter-chip" [ngClass]="{ active: filterSide() === 'Both' }"
                                (click)="filterSide.set('Both')">åŒæ–¹</button>
                        </div>
                    </div>
                </div>

                <!-- spine -->
                @if (milestoneSpine().length) {
                <div class="ts-spine">
                    <button type="button" class="ts-spine-pill" [ngClass]="{ active: filterMilestone() === 'all' }"
                        (click)="filterMilestone.set('all')">
                        å…¨éƒ¨
                    </button>
                    <button type="button" class="ts-spine-pill" [ngClass]="{ active: filterMilestone() === 'unbound' }"
                        (click)="filterMilestone.set('unbound')" title="æœªå…³è”ä»»ä½•é‡Œç¨‹ç¢‘çš„å¤‡æ³¨å’Œä¿¡å‡½">
                        æœªå…³è”
                    </button>

                    @for (m of milestoneSpine(); track m.id) {
                    <button type="button" class="ts-spine-pill" [ngClass]="{ active: filterMilestone() === m.id }"
                        (click)="filterMilestone.set(m.id)">
                        <span class="ts-spine-title">{{ m.label || '(æœªå‘½å)' }}</span>
                        <span class="ts-spine-meta">
                            @if (m.milestone?.status) {
                            <span class="ts-chip ts-chip--ms">
                                {{ m.milestone?.status === 'planned' ? 'è®¡åˆ’' : m.milestone?.status === 'in_progress' ?
                                'è¿›è¡Œ' : 'å®Œæˆ' }}
                            </span>
                            }
                            @if (m.milestone?.dueAt) {
                            <span class="ts-chip ts-chip--ms">{{ m.milestone?.dueAt | date : 'MM-dd' }}</span>
                            }
                        </span>
                    </button>
                    }
                </div>
                }

                <div class="ts-shard-list-container">
                    @if (!shardsForCurrentProject().length) {
                    <div class="ts-empty-text">
                        <p>ğŸŒ± è¿˜æ²¡æœ‰ä»»ä½•è®°å½•</p>
                        <p style="font-size: 0.8rem;">ä»ä¸Šæ–¹æ·»åŠ ç¬¬ä¸€æ¡é‡Œç¨‹ç¢‘æˆ–å¤‡æ³¨å¼€å§‹å§</p>
                    </div>
                    }

                    @if (shardsForCurrentProject().length && !visibleShards().length) {
                    <div class="ts-empty-text">
                        <p>ğŸ” æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„è®°å½•</p>
                        <p style="font-size: 0.8rem;">å°è¯•æ¸…é™¤ç­›é€‰æ¡ä»¶æˆ–æ›´æ¢å…³é”®è¯</p>
                    </div>
                    }

                    @if (visibleShards().length) {
                    <ul class="ts-shard-list">
                        @for (s of visibleShards(); track s.id) {
                        <li class="ts-shard-item" [ngClass]="{ 'is-editing': editingShardId() === s.id }">
                            <div class="ts-shard-top">
                                <div class="ts-shard-label">
                                    {{ s.label }}
                                    <span class="ts-chip ts-chip--kind">
                                        {{ s.kind === 'Note' ? 'å¤‡æ³¨' : s.kind === 'Milestone' ? 'é‡Œç¨‹ç¢‘' : 'ä¿¡å‡½' }}
                                    </span>

                                    @let mid = boundMilestoneIdOf(s);
                                    @if (mid) {
                                    <button type="button" class="ts-chip ts-chip--ms-link"
                                        (click)="applyMilestoneFilter(mid)" title="æŒ‰æ­¤é‡Œç¨‹ç¢‘ç­›é€‰">
                                        # {{ milestoneTitleById()[mid] }}
                                    </button>
                                    }

                                    @if (s.kind === 'Letter' && s.letter) {
                                    <span class="ts-chip ts-chip--kind" style="background:#fff; border-color:#ebeef5;">
                                        {{ s.letter.type === 'Proposal' ? 'ææ¡ˆ' : s.letter.type === 'Change' ? 'å˜æ›´' :
                                        'ç¡®è®¤' }}
                                        Â· v{{ s.letter.version }}
                                    </span>
                                    }

                                    @if (s.seal?.entryHash) {
                                    <span class="ts-chip ts-chip--hash" title="å·²å°å­˜éªŒè¯">ğŸ”’ å·²å°å­˜</span>
                                    }
                                </div>

                                <div class="ts-shard-top-right"
                                    style="display:flex; flex-direction:column; align-items:flex-end; gap:0.4rem;">
                                    <div class="ts-shard-meta" style="display:flex; gap:0.4rem;">
                                        <span class="ts-chip ts-chip--side">
                                            {{ s.side === 'Artist' ? 'ç”»å¸ˆ' : s.side === 'Client' ? 'é‡‘ä¸»' : 'åŒæ–¹' }}
                                        </span>
                                        <span class="ts-chip ts-chip--time">
                                            {{ s.createdAt | date : 'yyyy-MM-dd HH:mm' }}
                                        </span>
                                    </div>

                                    <div class="ts-shard-actions">
                                        @if (s.kind === 'Milestone') {
                                        <button type="button" class="ts-chip-btn"
                                            (click)="applyMilestoneFilter(s.id)">èšç„¦</button>
                                        }

                                        @if (s.kind === 'Letter') {
                                        <button type="button" class="ts-chip-btn"
                                            (click)="copyLetterTextFromShard(s)">å¤åˆ¶</button>
                                        @if (!s.seal && s.letter?.status !== 'confirmed') {
                                        <button type="button" class="ts-chip-btn"
                                            (click)="markLetterSent(s.id)">æ ‡è®°å‘é€</button>
                                        <button type="button" class="ts-chip-btn"
                                            (click)="confirmLetter(s.id, 'Artist')">ç¡®è®¤ (ç”»)</button>
                                        <button type="button" class="ts-chip-btn"
                                            (click)="confirmLetter(s.id, 'Client')">ç¡®è®¤ (é‡‘)</button>
                                        } @else if (!s.seal) {
                                        <button type="button" class="ts-chip-btn"
                                            (click)="createChangeLetterFrom(s)">å‘èµ·å˜æ›´</button>
                                        }
                                        }

                                        @if (!s.seal) {
                                        <button type="button" class="ts-chip-btn"
                                            (click)="startEditShard(s)">ç¼–è¾‘</button>
                                        <button type="button" class="ts-chip-btn danger"
                                            (click)="deleteShard(s.id)">åˆ é™¤</button>
                                        <button type="button" class="ts-chip-btn" (click)="sealShardOnline(s.id)"
                                            title="ç”Ÿæˆé˜²ç¯¡æ”¹å“ˆå¸Œå¹¶ä¸Šä¼ éªŒè¯">ğŸ”’ å°å­˜</button>
                                        } @else {
                                        <button type="button" class="ts-chip-btn"
                                            (click)="copyPublicReceipt(s)">å›æ‰§</button>
                                        <button type="button" class="ts-chip-btn danger"
                                            (click)="revokeSealOnline(s)">æ’¤é”€</button>
                                        }
                                    </div>
                                </div>
                            </div>

                            @if (s.details) {
                            <div class="ts-shard-details">{{ s.details }}</div>
                            }

                            @if (s.kind === 'Milestone' && (s.milestone?.dueAt || s.milestone?.status)) {
                            <div class="ts-seal-inline">
                                @if (s.milestone?.status) {
                                çŠ¶æ€ï¼š{{ s.milestone!.status === 'planned' ? 'è®¡åˆ’ä¸­' : s.milestone!.status === 'in_progress'
                                ? 'è¿›è¡Œä¸­' : 'å·²å®Œæˆ' }}
                                }
                                @if (s.milestone?.dueAt) { Â· æˆªæ­¢ï¼š{{ s.milestone!.dueAt | date : 'yyyy-MM-dd' }} }
                            </div>
                            }

                            @if (s.seal?.entryHash) {
                            <div class="ts-seal-inline"
                                style="background:#ecf5ff; color:#409eff; border:1px solid #d9ecff;">
                                ğŸ”’ å·²å°å­˜äº {{ s.seal!.sealedAt | date:'yyyy-MM-dd HH:mm' }}
                                <span style="font-family:monospace; font-size:0.7em; margin-left:4px;">{{
                                    s.seal!.entryHash.slice(0, 10) }}...</span>
                            </div>
                            }

                            <!-- artifacts -->
                            <div class="ts-artifacts-inline">
                                <div class="ts-artifacts-inline-title">ğŸ“ é™„ä»¶è¯æ® (SHA-256 å“ˆå¸Œ)</div>

                                @if (!s.seal) {
                                <div class="ts-artifact-row">
                                    <input class="ts-input ts-input--compact" type="text" placeholder="å¯é€‰ï¼šæ–‡ä»¶å¤‡æ³¨"
                                        [ngModel]="artifactNote()" (ngModelChange)="artifactNote.set($event)"
                                        style="flex:1;" />
                                    <label class="ts-btn ghost file-label"
                                        style="padding: 0.3rem 0.8rem; font-size: 0.8rem;">
                                        + æ·»åŠ æ–‡ä»¶
                                        <input type="file" multiple (change)="onArtifactFilesSelected($event, s.id)" />
                                    </label>
                                </div>
                                } @else {
                                <div style="font-size: 0.75rem; color: #909399; margin-bottom: 0.5rem;">
                                    â„¹ï¸ è®°å½•å·²å°å­˜ï¼Œæ— æ³•å†æ·»åŠ æˆ–ä¿®æ”¹é™„ä»¶ä»¥ç¡®ä¿è¯æ®é“¾å®Œæ•´ã€‚
                                </div>
                                }

                                @if (s.artifacts?.length) {
                                <ul class="ts-artifacts-inline-list">
                                    @for (a of s.artifacts; track a.sha256; let ai = $index) {
                                    <li class="ts-artifacts-inline-item">
                                        <span class="ts-artifacts-inline-name" title="{{ a.name }}">{{ a.name }}</span>
                                        <span class="ts-artifacts-inline-hash" title="{{ a.sha256 }}">{{
                                            a.sha256.slice(0, 10) }}...</span>
                                        <span style="font-size: 0.7rem; color: #909399;">{{ (a.size / 1024).toFixed(1)
                                            }} KB</span>
                                        @if (!s.seal) {
                                        <button type="button" class="ts-chip-btn danger"
                                            (click)="removeArtifact(s.id, ai)"
                                            style="padding: 0.1rem 0.4rem; font-size: 0.7rem;">Ã—</button>
                                        }
                                    </li>
                                    }
                                </ul>
                                } @else {
                                <div style="font-size: 0.8rem; color: #c0c4cc; font-style: italic;">æš‚æ— é™„ä»¶</div>
                                }
                            </div>
                        </li>
                        }
                    </ul>
                    }
                </div>
            </div>
        </section>
        } @else {
        <section class="ts-panel ts-panel--empty"
            style="display:flex; align-items:center; justify-content:center; color: var(--sd-muted);">
            <div style="text-align: center;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ¨</div>
                <p>è¯·é€‰æ‹©æˆ–åˆ›å»ºä¸€ä¸ªé¡¹ç›®å¼€å§‹è®°å½•</p>
            </div>
        </section>
        }
        }
        @if (currentView() === 'calculator') {
        <div class="ts-panel">

            <!-- å¤´éƒ¨ -->
            <div class="ts-card ts-log-card" style="padding: 1.5rem;">
                <div class="ts-log-header">
                    <h2>ğŸ§® è´¹ç‡è®¡ç®—å™¨</h2>
                    <button class="ts-btn subtle" (click)="resetCalculator()">é‡ç½®</button>
                </div>

                <!-- æ¨¡å¼åˆ‡æ¢ -->
                <div class="ts-calc-mode-switch">
                    <button class="ts-filter-chip" [class.active]="calcMode() === 'forward'"
                        (click)="calcMode.set('forward')">
                        æ­£ç®— (ç¨å‰ â†’ åˆ°æ‰‹)
                    </button>
                    <button class="ts-filter-chip" [class.active]="calcMode() === 'backward'"
                        (click)="calcMode.set('backward')">
                        åç®— (åˆ°æ‰‹ â†’ ç¨å‰)
                    </button>
                </div>

                <!-- è¾“å…¥åŒºåŸŸ -->
                <div class="ts-form-grid" style="margin-top: 1.5rem;">
                    <label class="ts-input-label">
                        {{ calcMode() === 'forward' ? 'ç¨å‰é‡‘é¢ (å…ƒ)' : 'æœŸæœ›åˆ°æ‰‹ (å…ƒ)' }}
                    </label>
                    <div class="ts-input-wrapper">
                        <span class="ts-input-prefix">Â¥</span>
                        <input type="number" class="ts-input" [value]="inputAmount()"
                            (input)="inputAmount.set(+($event.target).value)" placeholder="0.00" step="0.01" />
                    </div>

                    <label class="ts-input-label">ç¨ç‡ (%)</label>
                    <input type="number" class="ts-input" [value]="taxRate() * 100"
                        (input)="taxRate.set(+($event.target).value / 100)" step="0.1" />

                    <label class="ts-input-label">å¹³å°æŠ½æˆ (%)</label>
                    <input type="number" class="ts-input" [value]="platformRate() * 100"
                        (input)="platformRate.set(+($any($event.target).value) / 100)" step="0.1" />
                </div>

                <!-- ç»“æœå±•ç¤º -->
                @if (calculationResult(); as res) {
                @if (res['error']) {
                <div class="ts-alert-danger">{{ res['error'] }}</div>
                } @else {
                <div class="ts-calc-result-box">
                    <div class="ts-result-row main">
                        <span>ç¨å‰æ€»é¢</span>
                        <span class="ts-result-value">Â¥ {{ res.preTax }}</span>
                    </div>
                    <div class="ts-result-row">
                        <span>å¹³å°æ‰£é™¤ ({{ platformRate() * 100 }}%)</span>
                        <span class="ts-result-value text-danger">- Â¥ {{ res.platformFee }}</span>
                    </div>
                    <div class="ts-result-row">
                        <span>ç¨è´¹ä¼°ç®— ({{ taxRate() * 100 }}%)</span>
                        <span class="ts-result-value text-danger">- Â¥ {{ res.taxFee }}</span>
                    </div>
                    <div class="ts-divider"></div>
                    <div class="ts-result-row highlight">
                        <span>é¢„è®¡åˆ°æ‰‹</span>
                        <span class="ts-result-value text-success">Â¥ {{ res.postTax }}</span>
                    </div>
                </div>

                <p class="ts-hint-text">
                    ğŸ’¡ æç¤ºï¼šæ­¤è®¡ç®—ä»…ä¾›å‚è€ƒï¼Œå®é™…æ‰£è´¹è¯·ä»¥å¹³å°è´¦å•ä¸ºå‡†ã€‚æ•°æ®ä»…åœ¨æœ¬åœ°è®¡ç®—ï¼Œä¸ä¼šä¸Šä¼ ã€‚
                </p>
                }
                } @else {
                <div class="ts-empty-text">è¾“å…¥é‡‘é¢æŸ¥çœ‹è®¡ç®—ç»“æœ</div>
                }
            </div>
        </div>
        }

    </main>
    <!-- ===== Export Summary Modal (å¯¼å‡ºæˆåŠŸæ‘˜è¦) ===== -->
    @if (showExportSummary()) {
    <div class="ts-modal-overlay" (click)="closeExportSummary()">
        <div class="ts-modal-card" (click)="$event.stopPropagation()">

            <!-- Header -->
            <div class="ts-modal-header">
                <span class="ts-modal-icon">âœ…</span>
                <h3>å¤‡ä»½å·²æˆåŠŸç”Ÿæˆ</h3>
                <button class="ts-btn subtle" (click)="closeExportSummary()"
                    style="border:none; padding:0.5rem;">âœ•</button>
            </div>

            <!-- Body -->
            <div class="ts-modal-body">
                <p class="ts-summary-text">
                    å·²ä¸ºæ‚¨ä¿å­˜ <strong>{{ exportStats()?.projectCount }}</strong> ä¸ªé¡¹ç›®ï¼Œ
                    å…± <strong>{{ exportStats()?.shardCount }}</strong> æ¡è®°å½•ã€‚
                    <br />
                    <span class="ts-hint">
                        ğŸ’¡ æç¤ºï¼šJSON æ–‡ä»¶æ˜¯æ•°æ®å¤‡ä»½ï¼Œè¯·å‹¿æ‰‹åŠ¨ç¼–è¾‘ã€‚å¦‚æœ‰éœ€è¦æŸ¥çœ‹å†…å®¹ï¼Œè¯·ä½¿ç”¨â€œå¯¼å…¥â€åŠŸèƒ½é‡æ–°åŠ è½½ã€‚
                    </span>
                </p>

                <!-- é¡¹ç›®é¢„è§ˆåˆ—è¡¨ -->
                <div class="ts-preview-list">
                    <div class="ts-preview-title">åŒ…å«é¡¹ç›®ï¼š</div>
                    @for (p of exportStats()?.projects; track p.name) {
                    <div class="ts-preview-item">
                        <span class="ts-preview-name">{{ p.name }}</span>
                        <span class="ts-preview-meta">{{ p.count }} æ¡è®°å½•</span>
                    </div>
                    }
                </div>

                <!-- æ–‡ä»¶ä¿¡æ¯ -->
                <div class="ts-file-info">
                    ğŸ“„ æ–‡ä»¶åï¼š<code>{{ exportStats()?.fileName }}</code>
                </div>
            </div>

            <!-- Footer -->
            <div class="ts-modal-footer">
                <button class="ts-btn primary" (click)="closeExportSummary()">çŸ¥é“äº†</button>
            </div>

        </div>
    </div>
    }
</div>